import{r as e,R as t,L as a,P as i,a as s,C as r,S as l,U as o,B as n,b as g,D as p,c as h,I as m,_ as c,d as u}from"./vendor.039c3a11.js";function I(e){const{width:t,height:a}=e,i=document.createElement("canvas"),s=i.getContext("2d");i.width=t,i.height=a,s.drawImage(e,0,0);return s.getImageData(0,0,t,a)}function d(e){const{width:t,height:a,data:i}=e;let s,r=0;const l=[];for(let o=0;o<a;o++){s=0;for(let e=0;e<t;e++)s+=i[r]+i[r+1]+i[r+2],r+=4;l.push(s)}return l}class v{constructor(e,t){this.topImage=e,this.botImage=t,this.lowerBound=1,this.upperBound=1,this.overlapAreas=[],this.isSameImage=!1,this.isValidOverlapInfos=!1,this.beginOverlapTopImageRow=0,this.beginOverlapBotImageRow=0,this.overlapLength=0}findBestOverlapAreas(){this.findAllOverlapAreas(),this.selectBestOverlapArea(),this.checkOrderedOfImages()}findAllOverlapAreas(){for(;!this.isValidOverlapInfos&&this.lowerBound>=.99&&!this.isSameImage;)console.log(`Stitching with lowerBound: ${this.lowerBound}, upperBound:${this.upperBound}`),this.calcultateOverlap(),this.lowerBound-=.01,this.upperBound+=.01,this.verifyDetectedOverlapAreas(),console.log(this.overlapAreas)}calcultateOverlap(){if(this.topImage&&this.botImage){const e=d(this.topImage),t=d(this.botImage),a=e.length,i=t.length,s=[[],[]];for(let r=0;r<i;r++)s[0][r]=s[1][r]=0;for(let r=0;r<a;r++){if(r>a/5&&.6*r<=this.overlapAreas.length){console.log("much overlap");break}let l=e[r];for(let e=0;e<i;e++){let a=t[e];if(this.isApproximateTo(l,a)){let t=0;if(0!==e){t=s[(r+1)%2][e-1]+1}if(s[r%2][e]=t,t>80){const a={};a.overlapHeight=t,a.beginOverlapTopImage=r-t+1,a.beginOverlapBotImage=e-t+1,a.distance=a.beginOverlapTopImage-a.beginOverlapBotImage,a.distance>10&&this.addToListInfor(a)}}else s[r%2][e]=0}}}}selectBestOverlapArea(){for(const e of this.overlapAreas)e.overlapHeight>this.overlapLength&&(this.overlapLength=e.overlapHeight,this.beginOverlapTopImageRow=e.beginOverlapTopImage,this.beginOverlapBotImageRow=e.beginOverlapBotImage)}checkOrderedOfImages(){if(this.beginOverlapTopImageRow<this.beginOverlapBotImageRow){let e=this.beginOverlapTopImageRow,t=this.topImage;this.beginOverlapTopImageRow=this.beginOverlapBotImageRow,this.beginOverlapBotImageRow=e,this.topImage=this.botImage,this.botImage=t}}addToListInfor(e){let t=!1;for(const a of this.overlapAreas)if((this.isApproximateIndex(e.beginOverlapBotImage,a.beginOverlapBotImage)||this.isApproximateIndex(e.beginOverlapTopImage,a.beginOverlapTopImage))&&this.isApproximateIndex(e.overlapHeight,a.overlapHeight)&&(t=!0,e.overlapHeight>a.overlapHeight)){a.overlapHeight=e.overlapHeight,e.beginOverlapTopImage<a.beginOverlapTopImage&&(a.beginOverlapTopImage=e.beginOverlapTopImage),e.beginOverlapBotImage>a.beginOverlapBotImage&&(a.beginOverlapBotImage=e.beginOverlapBotImage);break}t||this.overlapAreas.push(e)}verifyDetectedOverlapAreas(){for(const e of this.overlapAreas){if(0===e.distance&&e.overlapHeight>.99*this.topImage.height){this.isSameImage=!0;break}e.distance>100&&(this.isValidOverlapInfos=!0)}}isApproximateTo(e,t){return t>=e*this.lowerBound&&t<=e*this.upperBound}isApproximateIndex(e,t){return e>=t-8&&e<=t+8}currentDistance(){return this.beginOverlapTopImageRow-this.beginOverlapBotImageRow}sufficientOverlapHeight(){return.3*this.topImage.height}}class f{constructor(e){this.images=e,this.result=null,this.init()}init(){this.listMergeInfors=[],this.calculateMergeInfors(),this.stitch()}calculateMergeInfors(){for(let e=0;e<this.images.length-1;e++){const t=I(this.images[e]),a=I(this.images[e+1]);let i=new v(t,a);i.findBestOverlapAreas(),this.listMergeInfors.push(i),i=null,console.log("stitchImage",i)}}stitch(){let e;for(let t=0;t<this.listMergeInfors.length;t++)0!==t?(this.listMergeInfors[t].beginOverlapTopImageRow=this.listMergeInfors[t-1].beginOverlapTopImageRow+this.listMergeInfors[t].beginOverlapTopImageRow-this.listMergeInfors[t-1].beginOverlapBotImageRow,this.listMergeInfors[t].topImage=e,e=this.generateImage(this.listMergeInfors[t])):e=this.generateImage(this.listMergeInfors[t]);this.result=e}generateImage(e){const{topImage:t,botImage:a,beginOverlapTopImageRow:i,beginOverlapBotImageRow:s}=e,r=i+a.height-s,l=document.createElement("canvas"),o=l.getContext("2d");l.width=t.width,l.height=r;const n=r-a.height;o.putImageData(t,0,0),o.putImageData(a,0,n,0,s,a.width,a.height-s);return o.getImageData(0,0,t.width,r)}}const{Content:O}=a;function b(e){return new Promise(((t,a)=>{const i=new FileReader;i.readAsDataURL(e),i.onload=()=>t(i.result),i.onerror=e=>a(e)}))}function w(){const[u,I]=e.exports.useState([{uid:0,name:0,url:"/stitch/assets/0.a6d352a3.jpg"},{uid:1,name:1,url:"/stitch/assets/1.6169f561.jpg"},{uid:2,name:2,url:"/stitch/assets/2.3dcc1a00.jpg"},{uid:3,name:3,url:"/stitch/assets/3.55cea401.jpg"},{uid:4,name:4,url:"/stitch/assets/4.b7c612f3.jpg"},{uid:5,name:5,url:"/stitch/assets/5.8e1ee4b2.jpg"},{uid:6,name:6,url:"/stitch/assets/6.51b4f8c2.jpg"}]),[d,v]=e.exports.useState(""),[w,B]=e.exports.useState(!1),E=async()=>(e=>{const t=[];return e.forEach((e=>{const a=new Promise(((t,a)=>{const i=document.createElement("img");i.src=e,i.onload=()=>{t(i)},i.onerror=()=>{a()}}));t.push(a)})),Promise.all(t)})(u.map((e=>e.url)));return t.createElement("div",{className:"App"},t.createElement(a,null,t.createElement(i,{title:"截图合成工具"}),t.createElement(O,null,t.createElement(s,{justify:"space-between"},t.createElement(r,null,t.createElement(l,null,t.createElement(o,{accept:".jpg,.jpeg",fileList:u,multiple:!0,listType:"picture",onChange:async e=>{let t=e.fileList;for(let a of t)a.url||(a.url=await b(a.originFileObj));I(c.sortBy(t,["lastModified"]))},beforeUpload:()=>!1,showUploadList:!1},t.createElement(n,{type:"primary",icon:t.createElement(g,null),size:"large"},"Upload")),t.createElement(n,{size:"large",icon:t.createElement(p,null),onClick:()=>{v(""),I([])}},"Clean"))),t.createElement(r,null,t.createElement(n,{type:"primary",size:"large",disabled:!(u.length>=2),loading:w,onClick:async()=>{B(!0),console.time("stitch");const e=await E(),t=new f([...e]),a=document.createElement("canvas");a.width=t.result.width,a.height=t.result.height;a.getContext("2d").putImageData(t.result,0,0),v(a.toDataURL("image/jpeg")),console.timeEnd("stitch"),B(!1)}},"Stitch"))),t.createElement(h,null),t.createElement("div",{className:"upload-preview"},t.createElement(m.PreviewGroup,null,u.map((e=>t.createElement(m,{key:e.uid,alt:e.name,width:100,src:e.url}))))),t.createElement(s,{justify:"center"},t.createElement(r,{span:12},d&&t.createElement(m,{src:d}))),t.createElement("div",{className:"result"}))))}console.log("0.0.2"),u.render(t.createElement(t.StrictMode,null,t.createElement(w,null)),document.getElementById("root"));
